# Rain Deployer

Plan for using [Rain](https://github.com/aws-cloudformation/rain) as the deployment tool for CloudFormation templates generated by cloudformation_dataclasses.

## Overview

Rain is AWS's official CLI tool for CloudFormation development. Templates generated by cloudformation_dataclasses are standard CloudFormation JSON/YAML and work with Rain out of the box - no special modifications needed.

## Why Rain?

| Feature | AWS CLI | Rain |
|---------|---------|------|
| Deploy speed | Sequential | Parallel uploads |
| Progress display | Basic | Rich terminal UI |
| Diff before deploy | Manual | Built-in `rain diff` |
| Log streaming | Separate command | Built-in `rain logs` |
| Stack deletion | `aws cloudformation delete-stack` | `rain rm` |

## Workflow

```bash
# 1. Generate template from Python
python -m my_stack > template.yaml

# 2. Preview changes (optional)
rain diff template.yaml my-stack-name

# 3. Deploy with Rain
rain deploy template.yaml my-stack-name

# 4. Monitor logs
rain logs my-stack-name

# 5. Clean up
rain rm my-stack-name
```

### With Parameters

```bash
# Using a config file
rain deploy template.yaml my-stack --config config.yaml

# Or inline parameters
rain deploy template.yaml my-stack --params Environment=prod,InstanceType=t3.large
```

## Testing Strategy

### 1. Unit Tests (Current)

Validate generated JSON/YAML is syntactically correct:

```python
def test_template_valid_json():
    template = build_template()
    json_output = template.to_json()
    parsed = json.loads(json_output)
    assert "Resources" in parsed
```

### 2. cfn-lint Validation

See [PLAN_CFN_LINT.md](PLAN_CFN_LINT.md) for comprehensive CloudFormation validation with cfn-lint.

### 3. Third-Party Examples

Import templates from Rain's repository and validate round-trip:

1. Import Rain sample template with `cfn-dataclasses-import`
2. Generate Python code
3. Execute Python to produce YAML
4. Validate with cfn-lint

**Source templates:**
- https://github.com/aws-cloudformation/rain/tree/main/test/templates
- https://github.com/aws-cloudformation/rain/tree/main/cft

**Location:** `examples/third_party/rain_templates/`

### 4. End-to-End (Optional)

Real AWS deployment tests require:
- AWS credentials with CloudFormation permissions
- Test account or sandbox environment
- CI integration (GitHub Actions with AWS OIDC)

```yaml
# .github/workflows/e2e.yml (example)
jobs:
  deploy-test:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsRole
          aws-region: us-east-1

      - name: Install Rain
        run: |
          curl -L https://github.com/aws-cloudformation/rain/releases/latest/download/rain-linux-amd64 -o rain
          chmod +x rain
          sudo mv rain /usr/local/bin/

      - name: Generate and deploy
        run: |
          python -m examples.s3_bucket > template.yaml
          rain deploy template.yaml test-stack --yes
          rain rm test-stack --yes
```

## Rain Config Files

Generate config files for consistent deployments:

```yaml
# config/dev.yaml
Parameters:
  Environment: dev
  InstanceType: t3.small
Tags:
  Team: Platform
  CostCenter: Engineering
```

```yaml
# config/prod.yaml
Parameters:
  Environment: prod
  InstanceType: t3.large
Tags:
  Team: Platform
  CostCenter: Engineering
```

**Usage:**

```bash
rain deploy template.yaml dev-stack --config config/dev.yaml
rain deploy template.yaml prod-stack --config config/prod.yaml
```

## Project Structure Example

```
my_infrastructure/
├── my_infrastructure/
│   ├── __init__.py
│   ├── context.py
│   ├── main.py
│   └── resources/
├── config/
│   ├── dev.yaml
│   ├── staging.yaml
│   └── prod.yaml
├── generated/
│   └── template.yaml      # Generated output
├── Makefile
└── pyproject.toml
```

**Makefile:**

```makefile
.PHONY: generate deploy-dev deploy-prod

generate:
	python -m my_infrastructure > generated/template.yaml

deploy-dev: generate
	rain deploy generated/template.yaml dev-stack --config config/dev.yaml

deploy-prod: generate
	rain deploy generated/template.yaml prod-stack --config config/prod.yaml

diff-prod: generate
	rain diff generated/template.yaml prod-stack
```

## Status

**Current:** Full compatibility - Rain works with generated JSON/YAML output

**Planned:**
- Import Rain sample templates as test fixtures
- Document recommended project structure

## See Also

- [PLAN_CFN_LINT.md](PLAN_CFN_LINT.md) - cfn-lint integration for template validation
- [PLAN_RAIN.md](PLAN_RAIN.md) - Future Rain-specific integration (directives, modules)
- [Rain Documentation](https://aws-cloudformation.github.io/rain/)
- [Rain GitHub Repository](https://github.com/aws-cloudformation/rain)

---

**Last Updated:** 2025-12-21
