# cfn-lint Integration

Plan for integrating [cfn-lint](https://github.com/aws-cloudformation/cfn-lint) to validate CloudFormation templates generated by cloudformation_dataclasses.

## Overview

cfn-lint is AWS's official CloudFormation linter. It validates templates against the CloudFormation resource specification, catching errors before deployment.

## Why cfn-lint for This Project?

### What cloudformation_dataclasses Already Catches

The library is **type-safe by design**:

| Error Type | How It's Caught |
|------------|-----------------|
| Invalid enum values | `ServerSideEncryption.AES256` - can't misspell an enum |
| Wrong property types | IDE type hints warn at write-time |
| Invalid property names | Generated from CF spec, correct by construction |
| Missing resources (class refs) | `ref(SomeClass)` fails at import if class missing |

### What cfn-lint Catches That We Don't

| Error Type | Example | Why We Miss It |
|------------|---------|----------------|
| Missing required properties | `Function` without `runtime` | Valid Python, invalid CF |
| Invalid GetAtt attributes | `get_att(Bucket, "InvalidAttr")` | String attribute not validated |
| Typos in string values | `bucket_name = "my-buckt"` | Valid Python string |
| String refs to missing resources | `ref("NonExistentResource")` | String not checked at import |
| Circular dependencies | Resource A refs B, B refs A | Valid Python, invalid CF |
| Deprecated resources/properties | Old resource types | Not tracked in library |

### Alternatives Considered

| Tool | Purpose | Why Not |
|------|---------|---------|
| **cfn_nag** | Security rules (permissive IAM, open SGs) | Overkill for code generation testing |
| **taskcat** | Actually deploys to test accounts | Too heavy, needs AWS credentials |
| **validate-template** | Basic syntax check | Too weak, just checks YAML/JSON valid |
| **checkov** | Security/compliance | Broader scope than needed |

**cfn-lint is the right fit** - validates CF semantics without requiring deployment.

## Primary Use Cases

1. **Importer round-trip validation**
   - YAML → `cfn-dataclasses-import` → Python → execute → YAML → cfn-lint
   - Ensures import/export preserves valid CloudFormation

2. **Third-party example validation**
   - Validate imported templates from aws-cloudformation-templates, Rain, etc.
   - Catch any issues introduced during import

3. **Codegen regression testing**
   - If generator produces invalid property names or types, cfn-lint catches it

4. **User error detection**
   - Missing required properties
   - Typos in string values that bypass type safety
   - Invalid attribute names in GetAtt

## Known Caveats

From [cfn-lint docs](https://github.com/aws-cloudformation/cfn-lint):

> "If you use a template generator such as Troposphere or AWS's CDK, you may get more false positives."

We may need to configure ignored rules for patterns that are valid but cfn-lint doesn't recognize.

## Installation

Add to `pyproject.toml` as a dev dependency:

```toml
[project.optional-dependencies]
dev = [
    "cfn-lint>=1.0.0",
    # ... other dev deps
]
```

## Usage

### CLI

```bash
# Validate a template
cfn-lint template.yaml

# Validate with specific rules ignored
cfn-lint template.yaml --ignore-checks W

# JSON output for CI
cfn-lint template.yaml --format json
```

### Python API

```python
import json
import tempfile
from cfnlint import decode, runner

def validate_template_dict(template_dict: dict) -> list:
    """Validate a template dictionary with cfn-lint."""
    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
        json.dump(template_dict, f)
        f.flush()

        template, matches = decode.decode(f.name)
        if matches:
            return matches

        rules = runner.Runner(
            template=template,
            filename=f.name,
            config={},
        )
        return rules.run()
```

## Testing Strategy

### 1. Validate Example Outputs

```python
import pytest
from pathlib import Path

EXAMPLES_DIR = Path("examples")

def get_example_templates():
    """Find all example packages that can generate templates."""
    for example in EXAMPLES_DIR.rglob("main.py"):
        yield example.parent

@pytest.mark.parametrize("example_path", get_example_templates())
def test_example_cfn_lint(example_path):
    """Generated template passes cfn-lint validation."""
    # Import and build template
    # Validate with cfn-lint
    # Assert no errors (or only expected warnings)
```

### 2. Importer Round-Trip Tests

```python
def test_import_roundtrip_valid(tmp_path):
    """Imported template produces valid CloudFormation."""
    # 1. Take original YAML
    # 2. Import to Python with cfn-dataclasses-import
    # 3. Execute Python to generate YAML
    # 4. Validate with cfn-lint
    # 5. Compare key structures match
```

### 3. Known Exceptions

Document rules we intentionally ignore in `.cfnlintrc`:

```yaml
# .cfnlintrc
ignore_checks:
  # Add rules here if we find false positives
  # - W3010  # Example: cross-stack ref pattern

configure_rules: {}
```

## CI Integration

```yaml
# .github/workflows/ci.yml
jobs:
  cfn-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install uv
          uv sync --all-extras

      - name: Generate and validate templates
        run: |
          pip install cfn-lint
          # Run cfn-lint validation tests
          uv run pytest tests/test_cfn_lint.py -v
```

## Implementation Phases

### Phase 1: Basic Integration
- Add cfn-lint to dev dependencies
- Create `.cfnlintrc` config
- Add CI step to validate generated templates

### Phase 2: Test Integration
- Add pytest fixture for cfn-lint validation
- Validate all examples in test suite
- Document known exceptions/false positives

### Phase 3: Importer Validation
- Add round-trip validation for third-party examples
- Ensure imported templates produce valid output

## Status

**Current:** Not integrated

**Planned:**
- Add cfn-lint as dev dependency
- Create validation tests for examples
- Add CI pipeline step
- Document any false positives we encounter

## See Also

- [PLAN_RAIN_DEPLOYER.md](PLAN_RAIN_DEPLOYER.md) - Rain deployment workflow
- [cfn-lint Documentation](https://github.com/aws-cloudformation/cfn-lint)
- [cfn-lint Rules Reference](https://github.com/aws-cloudformation/cfn-lint/blob/main/docs/rules.md)

---

**Last Updated:** 2025-12-21
