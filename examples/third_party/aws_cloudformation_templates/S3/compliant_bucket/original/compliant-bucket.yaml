AWSTemplateFormatVersion: '2010-09-09'
Description: 'A secure bucket that passes default security scanning checks.  Includes
  a

  bucket to store replicas and an access log bucket. Server side encryption is

  enabled. Public access is disabled. The bucket policy requires secure

  transport. Generated by CloudFormation Rain (rain build -b bucket bucket).

  Adapt this template to your needs and thoruoughly test it before introducing

  it in a production environment. **WARNING** This template will create

  resources in your account that may incur billing charges.

  '
Parameters:
  AppName:
    Type: String
    Description: This name be used as a prefix for resource names
Resources:
  ObjectStorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        RestrictPublicBuckets: true
        BlockPublicPolicy: true
        BlockPublicAcls: true
        IgnorePublicAcls: true
      BucketName:
        Fn::Sub: ${AppName}-${AWS::Region}-${AWS::AccountId}
      ObjectLockEnabled: false
      LoggingConfiguration:
        DestinationBucketName:
          Ref: ObjectStorageLogBucket
      ReplicationConfiguration:
        Role:
          Fn::GetAtt:
          - ObjectStorageReplicationRole
          - Arn
        Rules:
        - Status: Enabled
          Destination:
            Bucket:
              Fn::GetAtt:
              - ObjectStorageReplicaBucket
              - Arn
      Tags: []
  ObjectStorageBucketPolicyPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: ObjectStorageBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Deny
          Principal:
            AWS: '*'
          Action: s3:*
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-${AWS::Region}-${AWS::AccountId}
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-${AWS::Region}-${AWS::AccountId}/*
          Condition:
            Bool:
              aws:SecureTransport: false
        - Effect: Allow
          Principal:
            Service: logging.s3.amazonaws.com
          Action: s3:PutObject
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-${AWS::Region}-${AWS::AccountId}/*
          Condition:
            ArnLike:
              aws:SourceArn:
                Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-${AWS::Region}-${AWS::AccountId}
            StringEquals:
              aws:SourceAccount:
                Ref: AWS::AccountId
  ObjectStorageLogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        RestrictPublicBuckets: true
        BlockPublicPolicy: true
        BlockPublicAcls: true
        IgnorePublicAcls: true
      BucketName:
        Fn::Sub: ${AppName}-logs-${AWS::Region}-${AWS::AccountId}
      ObjectLockConfiguration:
        ObjectLockEnabled: Enabled
        Rule:
          DefaultRetention:
            Years: 1
            Mode: COMPLIANCE
      ObjectLockEnabled: true
      Tags: []
  ObjectStorageLogBucketPolicyPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: ObjectStorageLogBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Deny
          Principal:
            AWS: '*'
          Action: s3:*
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-logs-${AWS::Region}-${AWS::AccountId}
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-logs-${AWS::Region}-${AWS::AccountId}/*
          Condition:
            Bool:
              aws:SecureTransport: false
        - Effect: Allow
          Principal:
            Service: logging.s3.amazonaws.com
          Action: s3:PutObject
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-logs-${AWS::Region}-${AWS::AccountId}/*
          Condition:
            ArnLike:
              aws:SourceArn:
                Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-logs-${AWS::Region}-${AWS::AccountId}
            StringEquals:
              aws:SourceAccount:
                Ref: AWS::AccountId
  ObjectStorageReplicaBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        RestrictPublicBuckets: true
        BlockPublicPolicy: true
        BlockPublicAcls: true
        IgnorePublicAcls: true
      BucketName:
        Fn::Sub: ${AppName}-replicas-${AWS::Region}-${AWS::AccountId}
      ObjectLockEnabled: false
      Tags: []
  ObjectStorageReplicaBucketPolicyPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: ObjectStorageReplicaBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Deny
          Principal:
            AWS: '*'
          Action: s3:*
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-replicas-${AWS::Region}-${AWS::AccountId}
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-replicas-${AWS::Region}-${AWS::AccountId}/*
          Condition:
            Bool:
              aws:SecureTransport: false
        - Effect: Allow
          Principal:
            Service: logging.s3.amazonaws.com
          Action: s3:PutObject
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-replicas-${AWS::Region}-${AWS::AccountId}/*
          Condition:
            ArnLike:
              aws:SourceArn:
                Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-replicas-${AWS::Region}-${AWS::AccountId}
            StringEquals:
              aws:SourceAccount:
                Ref: AWS::AccountId
  ObjectStorageReplicationPolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName:
        Ref: ObjectStorageReplicationRole
      PolicyName: bucket-replication-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - s3:GetReplicationConfiguration
          - s3:ListBucket
          Resource:
            Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-${AWS::Region}-${AWS::AccountId}
        - Effect: Allow
          Action:
          - s3:GetObjectVersionForReplication
          - s3:GetObjectVersionAcl
          - s3:GetObjectVersionTagging
          Resource:
            Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-${AWS::Region}-${AWS::AccountId}/*
        - Effect: Allow
          Action:
          - s3:ReplicateObject
          - s3:ReplicateDelete
          - s3:ReplicationTags
          Resource:
            Fn::Sub: arn:${AWS::Partition}:s3:::${AppName}-replicas-${AWS::Region}-${AWS::AccountId}/*
  ObjectStorageReplicationRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - s3.amazonaws.com
          Action:
          - sts:AssumeRole
      Tags: []

